<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rafi's cookbook</title>
    <link rel="stylesheet" href="assets/styling/style.css">
</head>

<body class="mainbody">
    <div>
        <img src="assets/images/spine.jpg" id="spine">
    </div>
    <nav>
        <a href="./">
            <h1>Rafi's cookbook</h1>
        </a>
        <search>
            <input type="text" id="searchbox" placeholder="Pesquisar" onkeyup="search(this.value)">
            <div id="results">
                <p>O que tem em mente?</p>
            </div>
        </search>
    </nav>

    <iframe src="main.html" frameborder="0" id="frame"></iframe>

    <script>
        function searchableString(str) {
            str = str.toLowerCase();
            if (str.search(/[\xC0-\xFF]/g) > -1) {
                str = str
                    .replace(/[\xC0-\xC5]/g, "A")
                    .replace(/[\xC6]/g, "AE")
                    .replace(/[\xC7]/g, "C")
                    .replace(/[\xC8-\xCB]/g, "E")
                    .replace(/[\xCC-\xCF]/g, "I")
                    .replace(/[\xD0]/g, "D")
                    .replace(/[\xD1]/g, "N")
                    .replace(/[\xD2-\xD6\xD8]/g, "O")
                    .replace(/[\xD9-\xDC]/g, "U")
                    .replace(/[\xDD]/g, "Y")
                    .replace(/[\xDE]/g, "P")
                    .replace(/[\xE0-\xE5]/g, "a")
                    .replace(/[\xE6]/g, "ae")
                    .replace(/[\xE7]/g, "c")
                    .replace(/[\xE8-\xEB]/g, "e")
                    .replace(/[\xEC-\xEF]/g, "i")
                    .replace(/[\xF1]/g, "n")
                    .replace(/[\xF2-\xF6\xF8]/g, "o")
                    .replace(/[\xF9-\xFC]/g, "u")
                    .replace(/[\xFE]/g, "p")
                    .replace(/[\xFD\xFF]/g, "y");
            }
            return str;
        }

        function routeString(str) {
            return searchableString(str).replace(/[^A-Z0-9]+/ig, "_");
        }

        function search(input) {
            let keyword = searchableString(input.trim());
            let results = document.querySelector('#results')

            if (keyword != '') {
                fetch("assets/routes.json")
                    .then(res => res.json())
                    .then(islands => {
                        let search = []
                        islands.recipes.forEach(dropdown => {
                            let entry = [dropdown.options.filter(recipe => {
                                return searchableString(recipe).includes(keyword);
                            }), dropdown.title]
                            if (entry[0].length != 0) search.push(entry);
                        });
                        search.sort();
                        if (search.length != 0) {
                            results.innerHTML = `${search.map(dropdown => {
                                return dropdown[0].map(recipe => {
                                    return `<button id="${routeString(dropdown[1])}/${routeString(recipe)}" onclick="openOption(this)" class="search_result">${recipe.substr(0, searchableString(recipe).indexOf(keyword))
                                        }<b>${recipe.substr(searchableString(recipe).indexOf(keyword), keyword.length)
                                        }</b>${recipe.substr(searchableString(recipe).indexOf(keyword) + keyword.length)
                                        }</button>`;
                                }).join("");
                            }).join("")}`;
                        } else {
                            results.innerHTML = "<p>Nenhum resultado</p>";
                        }
                    });
            } else {
                results.innerHTML = "<p>O que tem em mente?</p>";
            }
        }

        function loadSideBar() {
            const nav = document.querySelector("nav");
            fetch("assets/routes.json")
                .then(res => res.json())
                .then(islands => {
                    for (const [name, content] of Object.entries(islands)) {
                        nav.insertAdjacentHTML("beforeend",
                            `<div id="${name}">
                                ${content.map(dropdown => {
                                return `
                                        <div class="dropdown" id="${routeString(dropdown.title)}">
                                            <label><input type="checkbox" ${currentRecipe.substr(1).split("/")[0] == routeString(dropdown.title) ? "checked" : ""}>${dropdown.title}<span class="material">arrow_forward_ios</span></label>
                                            <div>
                                                ${dropdown.options.map(recipe => {
                                    return `<button id="${routeString(recipe)}" onclick="openOption(this)" ${currentRecipe.split("/")[1] == routeString(recipe) ? "class=\"selected\"" : ""}>${recipe}</button>`
                                }).join("")}
                                            </div>
                                        </div>
                                    `
                            }).join("")}
                            </div>`
                        )
                    }
                });
        }

        function selectOption(recipe) {
            document.getElementById(recipe[0]).children[0].children[0].checked = true;
            document.getElementById(recipe[1]).classList.add("selected");
        }

        function deselectOption(recipe) {
            if (recipe != '') top.document.getElementById(recipe).classList.remove("selected");
        }

        function openOption(element) {
            let newUrl = element.id.split("/").length > 1 ? element.id : element.parentElement.parentElement.id + "/" + element.id;
            if (newUrl != currentRecipe) {
                deselectOption(currentRecipe.split("/")[1]);
                currentRecipe = newUrl;
                selectOption(currentRecipe.split("/"));
                window.history.pushState({}, "", "?" + newUrl);
                document.getElementById("frame").src = "recipe.html";
            }
        }

        var currentRecipe = window.location.search;
        loadSideBar();
        if (currentRecipe.length > 1) {
            document.getElementById("frame").src = "recipe.html";
        }
        addEventListener("popstate", (event) => {
            deselectOption(currentRecipe.split("/")[1]);
            currentRecipe = window.location.search;
            selectOption(currentRecipe.substr(1).split("/"));
            document.getElementById("frame").contentWindow.location.reload();
        });
    </script>
</body>

</html>